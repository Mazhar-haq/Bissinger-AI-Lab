<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bissinger's Herald Square Truffle Tracker</title>
    <style>
        :root {
            --bissingers-brown: #3d2b1f; 
            --bissingers-gold: #c5a059;  
            --bissingers-cream: #f9f6f2;
            --primary: var(--bissingers-brown);
            --secondary: #5d4037;
            --accent: var(--bissingers-gold);
            --success: #4a6741;
            --danger: #9e2a2b;
            --light: #f4eee8;
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Optima', 'Palatino', 'Segoe UI', serif;
            padding: 15px;
            background: var(--light);
            color: var(--bissingers-brown);
            line-height: 1.5;
        }

        .header {
            background: var(--bissingers-brown);
            color: var(--bissingers-gold);
            padding: 25px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-bottom: 3px solid var(--bissingers-gold);
        }

        .header h1 { font-size: 1.6rem; letter-spacing: 2px; text-transform: uppercase; font-weight: 300; }

        .floor-tabs { display: flex; gap: 10px; margin-bottom: 20px; }

        .tab-btn {
            flex: 1; padding: 15px; background: #e0dcd8; border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            color: #666; transition: all 0.3s;
        }

        .tab-btn.active { background: var(--bissingers-brown); color: var(--bissingers-gold); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        .floor-view { display: none; }
        .floor-view.active { display: block; }

        .card {
            background: var(--white); padding: 20px; border-radius: 4px; margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(61, 43, 31, 0.1); border: 1px solid rgba(197, 160, 89, 0.2);
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 600px) {
            .input-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        input, select { padding: 10px; border: 1px solid #dcdcdc; border-radius: 2px; width: 100%; font-size: 1rem; }

        .scanner-section {
            background: var(--bissingers-cream); border: 2px dashed var(--bissingers-gold);
            padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 4px;
        }

        .loading-spinner {
            display: none; margin: 10px auto; border: 4px solid rgba(0,0,0,0.1);
            width: 24px; height: 24px; border-radius: 50%; border-left-color: var(--bissingers-gold);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bissingers-brown); color: var(--bissingers-gold); }
        th { padding: 12px; text-align: left; font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid #f0f0f0; }

        .btn-row-scan {
            background: var(--bissingers-gold); color: var(--bissingers-brown);
            border: 1px solid var(--bissingers-brown); padding: 6px 10px; border-radius: 4px;
            font-size: 10px; cursor: pointer; text-transform: uppercase;
        }

        .pm-cell { display: flex; align-items: center; gap: 5px; }
        .pm-cell input { width: 60px; }

        .calculated { font-weight: bold; }
        .error { color: var(--danger); }
        
        .btn-ai { background: var(--bissingers-gold); color: var(--bissingers-brown); width: 100%; padding: 15px; border: 1px solid var(--bissingers-brown); font-weight: bold; cursor: pointer; text-transform: uppercase; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 12px 24px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; z-index: 1000; pointer-events: none; }

        @media (max-width: 600px) {
            th:nth-child(4), td:nth-child(4) { display: none; }
        }
    </style>
</head>
<body onload="init()">

    <div id="toast" class="toast">Action Complete</div>

    <div class="header">
        <h1>Bissinger's Herald Square Truffle Tracker</h1>
        <p id="displayDate">Loading...</p>
    </div>

    <!-- Management Info -->
    <div class="card">
        <div class="input-grid">
            <div class="input-group">
                <label>Inventory Date</label>
                <input type="date" id="trackingDate" onchange="updateDateDisplay(); saveData();">
            </div>
            <div class="input-group">
                <label>Opening MOD</label>
                <select id="openingMod" onchange="saveData()">
                    <option value="">Select...</option>
                    <option>Tom</option><option>Arin</option><option>Czar</option><option>Faith</option><option>Gully</option>
                </select>
            </div>
            <div class="input-group">
                <label>Closing MOD</label>
                <select id="closingMod" onchange="saveData()">
                    <option value="">Select...</option>
                    <option>Tom</option><option>Arin</option><option>Czar</option><option>Faith</option><option>Gully</option>
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="tab-btn" style="background:#eee; color:#333; flex:1;" onclick="clearAll()">Reset</button>
            <button class="tab-btn active" style="flex:2;" onclick="lockAM()">Lock AM Counts</button>
        </div>
    </div>

    <div class="floor-tabs">
        <button class="tab-btn active" id="btn-f6" onclick="switchFloor('f6')">6th Floor</button>
        <button class="tab-btn" id="btn-f1" onclick="switchFloor('f1')">1st Floor</button>
    </div>

    <input type="file" id="globalCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleBatchUpload(event)">
    <input type="file" id="rowCamera" accept="image/*" capture="environment" style="display: none;" onchange="handleRowUpload(event)">

    <!-- 6th Floor -->
    <div id="f6-view" class="floor-view active">
        <div class="card scanner-section">
            <div class="loading-spinner" id="loader-f6"></div>
            <button class="btn-ai" onclick="document.getElementById('globalCamera').click()">ðŸ“· Scan Whole Case</button>
        </div>
        <div class="card">
            <div class="table-container">
                <table>
                    <thead><tr><th>Flavor</th><th>AM</th><th>PM</th><th>Refill</th><th>End</th></tr></thead>
                    <tbody id="f6Body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 1st Floor -->
    <div id="f1-view" class="floor-view">
        <div class="card scanner-section">
            <div class="loading-spinner" id="loader-f1"></div>
            <button class="btn-ai" onclick="document.getElementById('globalCamera').click()">ðŸ“· Scan Whole Case</button>
        </div>
        <div class="card">
            <div class="table-container">
                <table>
                    <thead><tr><th>Flavor</th><th>AM</th><th>PM</th><th>Refill</th><th>End</th></tr></thead>
                    <tbody id="f1Body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        const f6List = ["Birthday Cake Truffle", "Wedding Cake Truffle", "Root Beer Float Truffle", "Milk Chocolate Raspberry Cream", "Dark Chocolate Candy Cane", "Dark Raspberry Truffle", "Creme Brulee Truffle", "Tiramisu Truffle", "Pineapple Upside Down Cake Truffle", "Red Velvet Cake Truffle", "Irish Cream Truffle", "Chocolate Souffle Truffle", "White Euro Truffle", "White Russian Truffle", "Chocolate Milk Shake Truffle", "Dark Chocolate Caramel Macchiato Truffle", "German Chocolate Truffle", "Dark Chocolate Cherry Cordials", "Milk Swiss Chocolate Truffle", "Dark Swiss Chocolate Truffle", "Dark Sea Salt Caramel Truffle", "Strawberry Truffle", "Strawberry Cheese Cake Truffle", "Pistachio Crown Truffle", "Italian Espresso Truffle", "Dark Chocolate Caramel", "Fresh Mint Truffle", "Dark Creme Mints", "Milk Sea Salt Caramel", "Dark Cinnamon Almond Caramel", "Milk Chocolate Swiss Pecan Cream", "Milk Vanilla Dreams", "French Vanilla B", "Milk Chocolate English Almond Toffee", "Dark Chocolate English Almond Toffee", "Dark Lemon Creme", "Raspberry Caramel Jewel"];
        const f1List = ["Birthday Cake Truffle", "Wedding Cake Truffle", "White Euro Truffle", "Dark Chocolate Sea Salt Caramel", "White Chocolate Christmas Cookie Truffle", "Dark Chocolate Candy Cane", "White Chocolate Eggnog", "Milk Chocolate Caramel Fudge Brownie", "Milk Chocolate Peanut Butter", "Milk Chocolate French Salt Caramel", "Cherry Cordials", "Milk Chocolate Swiss Pecan Creme"];

        let currentFloor = 'f6';
        let currentRowTarget = null;

        function init() {
            const d = document.getElementById('trackingDate');
            if (!d.value) d.valueAsDate = new Date();
            updateDateDisplay();
            renderRows(f6List, 'f6Body', 'f6');
            renderRows(f1List, 'f1Body', 'f1');
            loadData();
        }

        function renderRows(list, containerId, prefix) {
            const container = document.getElementById(containerId);
            list.forEach((name, i) => {
                const id = `${prefix}_${i}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-size: 0.85rem;">${name}</td>
                    <td><input type="number" id="${id}_am" oninput="calc('${id}')" placeholder="0"></td>
                    <td>
                        <div class="pm-cell">
                            <input type="number" id="${id}_pm" oninput="calc('${id}')" placeholder="0">
                            <button class="btn-row-scan" onclick="triggerRowScan('${id}', '${name}')">Scan</button>
                            <div class="loading-spinner" id="${id}_loader" style="width:14px;height:14px;border-width:2px;"></div>
                        </div>
                    </td>
                    <td><input type="number" id="${id}_refill" oninput="calc('${id}')" placeholder="0"></td>
                    <td class="calculated" id="${id}_end">0</td>
                `;
                container.appendChild(row);
            });
        }

        async function apiFetch(payload, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) return await response.json();
                    if (response.status === 429) await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                } catch (e) { if (i === retries - 1) throw e; }
            }
            throw new Error("API failed");
        }

        async function handleBatchUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const loader = document.getElementById(`loader-${currentFloor}`);
            loader.style.display = 'block';
            
            try {
                const base64 = await toBase64(file);
                const list = currentFloor === 'f6' ? f6List : f1List;
                const prompt = `This is an image of a chocolate truffle display case. Count the remaining truffles for each flavor: ${list.join(", ")}. Return ONLY JSON: {"results": [{"flavor": "Flavor Name", "count": 5}]}`;
                
                const data = await apiFetch({
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }] }],
                    generationConfig: { responseMimeType: "application/json" }
                });

                const results = JSON.parse(data.candidates[0].content.parts[0].text);
                results.results.forEach(res => {
                    const idx = list.indexOf(res.flavor);
                    if (idx !== -1) {
                        const input = document.getElementById(`${currentFloor}_${idx}_pm`);
                        input.value = res.count;
                        calc(`${currentFloor}_${idx}`);
                    }
                });
                showToast("Batch scan complete");
            } catch (e) {
                showToast("Scan failed. Try again.");
            } finally {
                loader.style.display = 'none';
            }
        }

        function triggerRowScan(id, flavor) {
            currentRowTarget = { id, flavor };
            document.getElementById('rowCamera').click();
        }

        async function handleRowUpload(event) {
            const file = event.target.files[0];
            if (!file || !currentRowTarget) return;
            const loader = document.getElementById(`${currentRowTarget.id}_loader`);
            loader.style.display = 'block';

            try {
                const base64 = await toBase64(file);
                const prompt = `Identify count for truffle flavor "${currentRowTarget.flavor}". Return ONLY the number.`;
                const data = await apiFetch({
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64.split(',')[1] } }] }]
                });

                const text = data.candidates[0].content.parts[0].text.trim();
                const count = parseInt(text.replace(/\D/g, ''));
                if (!isNaN(count)) {
                    document.getElementById(`${currentRowTarget.id}_pm`).value = count;
                    calc(currentRowTarget.id);
                    showToast(`Counted ${count} for ${currentRowTarget.flavor}`);
                }
            } catch (e) {
                showToast("Row scan failed");
            } finally {
                loader.style.display = 'none';
                currentRowTarget = null;
            }
        }

        function toBase64(file) { return new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(file); }); }

        function calc(id) {
            const pm = parseInt(document.getElementById(`${id}_pm`).value) || 0;
            const refill = parseInt(document.getElementById(`${id}_refill`).value) || 0;
            document.getElementById(`${id}_end`).textContent = pm + refill;
            saveData();
        }

        function switchFloor(f) {
            currentFloor = f;
            document.querySelectorAll('.floor-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${f}-view`).classList.add('active');
            document.getElementById(`btn-${f}`).classList.add('active');
        }

        function updateDateDisplay() {
            const d = new Date(document.getElementById('trackingDate').value);
            document.getElementById('displayDate').textContent = d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
        }

        function saveData() {
            const pack = (p, list) => list.map((_, i) => ({
                am: document.getElementById(`${p}_${i}_am`).value,
                pm: document.getElementById(`${p}_${i}_pm`).value,
                ref: document.getElementById(`${p}_${i}_refill`).value,
                l: document.getElementById(`${p}_${i}_am`).disabled
            }));
            const data = { 
                d: document.getElementById('trackingDate').value,
                oMod: document.getElementById('openingMod').value,
                cMod: document.getElementById('closingMod').value,
                f6: pack('f6', f6List),
                f1: pack('f1', f1List)
            };
            localStorage.setItem('biss_data_v3', JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem('biss_data_v3');
            if (!raw) return;
            const data = JSON.parse(raw);
            document.getElementById('trackingDate').value = data.d;
            document.getElementById('openingMod').value = data.oMod || '';
            document.getElementById('closingMod').value = data.cMod || '';
            updateDateDisplay();
            const unpack = (p, items) => items.forEach((item, i) => {
                const id = `${p}_${i}`;
                if (!document.getElementById(`${id}_am`)) return;
                document.getElementById(`${id}_am`).value = item.am;
                document.getElementById(`${id}_pm`).value = item.pm;
                document.getElementById(`${id}_refill`).value = item.ref;
                if (item.l) document.getElementById(`${id}_am`).disabled = true;
                calc(id);
            });
            unpack('f6', data.f6);
            unpack('f1', data.f1);
        }

        function lockAM() {
            document.querySelectorAll('input[id$="_am"]').forEach(el => el.disabled = true);
            saveData();
            showToast("Morning counts locked");
        }

        function clearAll() { if(confirm("Clear everything?")) { localStorage.clear(); location.reload(); } }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }
    </script>
</body>
</html>
