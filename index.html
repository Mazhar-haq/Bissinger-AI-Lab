<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bissinger's AI Lab - Precision Scanner</title>
    <style>
        :root {
            --bissingers-brown: #3d2b1f; 
            --bissingers-gold: #c5a059;  
            --light: #f4eee8;
            --white: #ffffff;
            --ai-purple: #7b2cbf;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Optima', 'Palatino', serif; padding: 10px; background: var(--light); color: var(--bissingers-brown); padding-bottom: 150px; }
        .header { background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 15px; border-radius: 4px; text-align: center; border-bottom: 3px solid var(--bissingers-gold); margin-bottom: 10px; }
        #aiStatus { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: var(--ai-purple); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 0.8rem; }
        .card { background: var(--white); padding: 12px; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .floor-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px; background: #ddd; border: none; border-radius: 4px; font-weight: bold; font-size: 0.7rem; }
        .tab-btn.active { background: var(--bissingers-brown); color: var(--bissingers-gold); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background: var(--bissingers-brown); color: var(--bissingers-gold); font-size: 0.6rem; padding: 8px 2px; text-transform: uppercase; }
        td { padding: 6px 2px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.8rem; overflow: hidden; }
        .flavor-cell { text-align: left; font-weight: bold; display: flex; align-items: center; gap: 4px; font-size: 0.7rem; }
        .row-scan-btn { background: var(--ai-purple); color: white; border: none; border-radius: 4px; padding: 4px 6px; font-size: 0.8rem; cursor: pointer; }
        .count-input { width: 100%; text-align: center; padding: 4px 0; border: 1px solid #ccc; border-radius: 2px; }
        .summary-footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bissingers-brown); color: var(--bissingers-gold); padding: 15px; text-align: center; }
        .floor-view { display: none; }
        .floor-view.active { display: block; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 8px 16px; border-radius: 4px; opacity: 0; transition: 0.3s; z-index: 10001; }
    </style>
</head>
<body onload="init()">

    <div id="aiStatus">ðŸ§  AI is identifying truffles...</div>
    <div id="toast" class="toast">Done</div>

    <div class="header">
        <h1>Bissinger's Precision Lab</h1>
        <input type="date" id="trackingDate" style="background: none; border: none; color: white; font-family: inherit;" onchange="saveData()">
    </div>

    <div class="floor-tabs">
        <button class="tab-btn active" id="btn-f6" onclick="switchFloor('f6')">6th Floor</button>
        <button class="tab-btn" id="btn-f1" onclick="switchFloor('f1')">1st Floor</button>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImage(event)">

    <div id="f6-view" class="floor-view active">
        <div class="card">
            <table>
                <thead>
                    <tr><th style="width: 45%;">Flavor</th><th style="width: 15%;">AM</th><th style="width: 15%;">Refill</th><th style="width: 15%;">PM</th><th style="width: 10%;">Sold</th></tr>
                </thead>
                <tbody id="f6Body"></tbody>
            </table>
        </div>
    </div>

    <div id="f1-view" class="floor-view">
        <div class="card">
            <table>
                <thead>
                    <tr><th style="width: 45%;">Flavor</th><th style="width: 15%;">AM</th><th style="width: 15%;">Refill</th><th style="width: 15%;">PM</th><th style="width: 10%;">Sold</th></tr>
                </thead>
                <tbody id="f1Body"></tbody>
            </table>
        </div>
    </div>

    <div class="summary-footer">
        <div style="font-size: 0.7rem;">TOTAL PIECES</div>
        <div id="total-grand" style="font-size: 1.5rem; font-weight: bold;">0</div>
    </div>

    <script>
        const f6List = ["BIRTHDAY CAKE TRUFFLE", "WEDDING CAKE TRUFFLE", "STRAWBERRY TRUFFLE", "DARK RASPBERRY TRUFFLE", "TIRAMISU TRUFFLE", "DARK SEA SALT CARAMEL TRUFFLE", "RED VELVET CAKE TRUFFLE", "IRISH CREAM TRUFFLE", "CHOCOLATE SOUFFLÃ‰ TRUFFLE", "WHITE EURO TRUFFLE", "DARK HIMALAYAN SEA SALT CARAMEL", "DARK CHOCOLATE CARAMEL", "FRESH MINT TRUFFLE", "MILK SEA SALT CARAMEL", "MILK CHOCOLATE PECAN CARAMEL"];
        const f1List = ["BIRTHDAY CAKE TRUFFLE", "WEDDING CAKE TRUFFLE", "WHITE EURO TRUFFLE", "FRESH MINT TRUFFLE", "PISTACHIO CROWN TRUFFLE"];

        let currentActiveRowId = null;
        let currentActiveFlavorName = "";

        function init() {
            const d = document.getElementById('trackingDate');
            if(!d.value) d.value = new Date().toISOString().split('T')[0];
            renderRows(f6List, 'f6Body', 'f6');
            renderRows(f1List, 'f1Body', 'f1');
            loadData();
        }

        function renderRows(list, containerId, prefix) {
            const container = document.getElementById(containerId);
            list.forEach((name, i) => {
                const id = `${prefix}_${i}`;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="flavor-cell">
                            <button class="row-scan-btn" onclick="startRowScan('${id}', '${name}')">ðŸ“¸</button>
                            <span>${name}</span>
                        </div>
                    </td>
                    <td><input type="number" id="${id}_am" class="count-input" oninput="calc('${id}')"></td>
                    <td><input type="number" id="${id}_refill" class="count-input" oninput="calc('${id}')"></td>
                    <td><input type="number" id="${id}_pm" class="count-input" oninput="calc('${id}')"></td>
                    <td id="${id}_sold">0</td>
                `;
                container.appendChild(tr);
            });
        }

        function startRowScan(id, name) {
            currentActiveRowId = id;
            currentActiveFlavorName = name;
            document.getElementById('cameraInput').click();
        }

        async function handleImage(event) {
            const file = event.target.files[0];
            if (!file || !currentActiveRowId) return;
            document.getElementById('aiStatus').style.display = 'block';
            document.getElementById('aiStatus').textContent = `Identifying ${currentActiveFlavorName}...`;
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Image = reader.result.split(',')[1];
                await callAI(base64Image);
            };
            reader.readAsDataURL(file);
        }

        async function callAI(base64Data) {
            const API_KEY = "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"; 
            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${API_KEY}`, 
                        "Content-Type": "application/json",
                        "HTTP-Referer": "https://mazhar-haq.github.io/", 
                        "X-Title": "Bissinger Tracker Lab"
                    },
                    body: JSON.stringify({
                        "model": "nvidia/nemotron-nano-12b-v2-vl:free",
                        "messages": [{
                            "role": "user",
                            "content": [
                                { "type": "text", "text": `Count the number of ${currentActiveFlavorName} pieces in this image. Return ONLY the number as a plain integer. If none, return 0.` },
                                { "type": "image_url", "image_url": { "url": `data:image/jpeg;base64,${base64Data}` } }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API error");
                }

                const result = await response.json();
                const aiResponse = result.choices[0].message.content.trim();
                const count = parseInt(aiResponse.replace(/[^0-9]/g, '')) || 0;
                
                document.getElementById(`${currentActiveRowId}_am`).value = count;
                calc(currentActiveRowId);
                showToast(`Found ${count} ${currentActiveFlavorName}`);
            } catch (e) {
                console.error(e);
                alert("AI Error: " + e.message);
            } finally {
                document.getElementById('aiStatus').style.display = 'none';
                document.getElementById('cameraInput').value = ""; // Reset input
            }
        }

        function calc(id) {
            const am = parseInt(document.getElementById(`${id}_am`).value) || 0;
            const pmVal = document.getElementById(`${id}_pm`).value;
            const pm = parseInt(pmVal) || 0;
            const soldEl = document.getElementById(`${id}_sold`);
            if (pmVal !== "") { soldEl.textContent = Math.max(0, am - pm); }
            updateTotals();
            saveData();
        }

        function updateTotals() {
            let total = 0;
            document.querySelectorAll('input[id$="_am"]').forEach(i => total += (parseInt(i.value) || 0));
            document.getElementById('total-grand').textContent = total;
        }

        function switchFloor(f) {
            document.querySelectorAll('.floor-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`${f}-view`).classList.add('active');
            document.getElementById(`btn-${f}`).classList.add('active');
        }

        function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 2000); }

        function saveData() {
            const data = {
                f6: f6List.map((_, i) => ({ am: document.getElementById(`f6_${i}_am`).value, pm: document.getElementById(`f6_${i}_pm`).value })),
                f1: f1List.map((_, i) => ({ am: document.getElementById(`f1_${i}_am`).value, pm: document.getElementById(`f1_${i}_pm`).value }))
            };
            localStorage.setItem('biss_lab_v2', JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem('biss_lab_v2');
            if (!raw) return;
            const d = JSON.parse(raw);
            const fill = (list, prefix, arr) => list.forEach((_, i) => {
                if(arr && arr[i]) { 
                    document.getElementById(`${prefix}_${i}_am`).value = arr[i].am; 
                    document.getElementById(`${prefix}_${i}_pm`).value = arr[i].pm;
                    calc(`${prefix}_${i}`);
                }
            });
            fill(f6List, 'f6', d.f6); fill(f1List, 'f1', d.f1);
        }
    </script>
</body>
</html>
